-- GENERAL VISUALIZATIONS --

-- Visualizing CovidDeaths table

SELECT *
FROM `ProjectsPortfolio.CovidDeaths`

-- Visualizing countries data ordered by location and date

SELECT *
FROM `ProjectsPortfolio.CovidDeaths`
WHERE continent IS NOT NULL
ORDER BY 3,4

-- Select data that we are going to use ordered by location and date

SELECT location, date, total_cases, new_cases, total_deaths, population
FROM `ProjectsPortfolio.CovidDeaths`
ORDER BY location, date

-- Total Cases vs Total Deaths by Country
-- Likelihood of dying if you contract Covid

SELECT location, date, total_cases, total_deaths, population, (total_deaths / total_cases)*100 AS DeathPercentage
FROM `ProjectsPortfolio.CovidDeaths`
ORDER BY location, date


-- COVID IN SPAIN --

-- Total Cases vs Total Deaths in Spain

SELECT location, date, total_cases, total_deaths, population, (total_deaths / total_cases)*100 AS DeathPercentage
FROM `ProjectsPortfolio.CovidDeaths`
WHERE location = 'Spain'
ORDER BY location, date

-- Total Cases vs Population in Spain
-- Percentage of population that got infected by Covid

SELECT location, date, population, total_cases, (total_cases / population)*100 AS PercentPopulationInfected
FROM `ProjectsPortfolio.CovidDeaths`
WHERE location = 'Spain'
ORDER BY location, date

-- COUNTRIES with highest Infection Rate compared to Population

SELECT location, population, MAX(total_cases) AS HighestInfectionCount, (MAX(total_cases) / population)*100 AS PercentPopulationInfected
FROM `ProjectsPortfolio.CovidDeaths`
GROUP BY location, population
ORDER BY PercentPopulationInfected DESC

-- COUNTRIES with the highest Death Count per population

SELECT location, MAX(total_deaths) AS TotalDeathCount
FROM `ProjectsPortfolio.CovidDeaths`
WHERE continent IS NOT NULL -- removes continents from the results
GROUP BY location
ORDER BY TotalDeathCount DESC

-- CONTINENTS with the Highest Death Count

SELECT location, MAX(total_deaths) AS TotalDeathCount
FROM `ProjectsPortfolio.CovidDeaths`
WHERE continent IS NULL AND location <> 'World'
GROUP BY location
ORDER BY TotalDeathCount DESC


-- GLOBAL NUMBERS --

-- New cases and new deaths in the world by day

SELECT date, SUM(new_cases) AS total_cases, SUM(new_deaths) AS total_deaths, SUM(new_deaths) / SUM(new_cases)*100 AS DeathPercentage
FROM `ProjectsPortfolio.CovidDeaths`
WHERE continent IS NOT NULL
GROUP BY date
ORDER BY 1,2

-- Total cases and total deaths in the world

SELECT SUM(new_cases) AS total_cases, SUM(new_deaths) AS total_deaths, SUM(new_deaths) / SUM(new_cases)*100 AS DeathPercentage
FROM `ProjectsPortfolio.CovidDeaths`
WHERE continent IS NOT NULL
ORDER BY 1,2


-- Visualizing COVID VACCINATIONS table

SELECT *
FROM `ProjectsPortfolio.CovidVaccinations`

-- JOINing both tables

SELECT *
FROM `ProjectsPortfolio.CovidDeaths` AS dea
JOIN `ProjectsPortfolio.CovidVaccinations` AS vac
  ON dea.location = vac.location AND dea.date = vac.date

-- Total Population vs Vaccinations in SPAIN

SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS RollingPeopleVaccinated
FROM `ProjectsPortfolio.CovidDeaths` AS dea
JOIN `ProjectsPortfolio.CovidVaccinations` AS vac
  ON dea.location = vac.location
  AND dea.date = vac.date
WHERE dea.continent IS NOT NULL AND dea.location = 'Spain'
ORDER BY 2,3  

-- USE CTE

WITH PopvsVac AS (
SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS RollingPeopleVaccinated
FROM `ProjectsPortfolio.CovidDeaths` AS dea
JOIN `ProjectsPortfolio.CovidVaccinations` AS vac
  ON dea.location = vac.location
  AND dea.date = vac.date
WHERE dea.continent IS NOT NULL
ORDER BY 2,3  
)

SELECT *, (RollingPeopleVaccinated/population)*100 AS RollingVaccinatedPercentage
FROM PopvsVac


-- TEMP TABLE (not possible to insert into in the free version of BigQuery)

BEGIN
CREATE TEMP TABLE PercentPopulationVaccinated
(
continent string,
location string,
date datetime,
population int64,
new_vaccinations int64,
RollingPeopleVaccinated float64
);
END

INSERT INTO PercentPopulationVaccinated
SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS RollingPeopleVaccinated
FROM `ProjectsPortfolio.CovidDeaths` AS dea
JOIN `ProjectsPortfolio.CovidVaccinations` AS vac
  ON dea.location = vac.location
  AND dea.date = vac.date
WHERE dea.continent IS NOT NULL
--ORDER BY 2,3  

SELECT *, (RollingPeopleVaccinated/population)*100
FROM PercentPopulationVaccinated

-- USING A NEW TABLE (not possible to insert into in the free version of BigQuery)

DROP TABLE IF EXISTS ProjectsPortfolio.PercentPopulationVaccinated
CREATE TABLE ProjectsPortfolio.PercentPopulationVaccinated
(
continent string,
location string,
date datetime,
population int64,
new_vaccinations int64,
RollingPeopleVaccinated float64
)

INSERT INTO ProjectsPortfolio.PercentPopulationVaccinated
SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS RollingPeopleVaccinated
FROM `ProjectsPortfolio.CovidDeaths` AS dea
JOIN `ProjectsPortfolio.CovidVaccinations` AS vac
  ON dea.location = vac.location
  AND dea.date = vac.date
WHERE dea.continent IS NOT NULL
--ORDER BY 2,3  

SELECT *, (RollingPeopleVaccinated/population)*100
FROM ProjectsPortfolio.PercentPopulationVaccinated


-- CREATE A VIEW to store data for later visualizations (not working in bigquery)

DROP TABLE IF EXISTS ProjectsPortfolio.PercentPopulationVaccinated
CREATE VIEW ProjectsPortfolio.PercentPopulationVaccinated AS
SELECT dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations
, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS RollingPeopleVaccinated
FROM `ProjectsPortfolio.CovidDeaths` AS dea
JOIN `ProjectsPortfolio.CovidVaccinations` AS vac
  ON dea.location = vac.location
  AND dea.date = vac.date
WHERE dea.continent IS NOT NULL

SELECT *
FROM ProjectsPortfolio.PercentPopulationVaccinated
